<div class="p-4 flex flex-col gap-4">

  <!-- HEADER -->
  <div class="flex justify-between items-center rounded-lg p-4 shadow-md" style="background-color: var(--primary-color); color: var(--primary-color-text);">
    <div>
      <h2 class="text-2xl font-bold">Sistema POS</h2>
      <p class="text-sm opacity-80">{{ getCurrentDateTime() }}</p>
    </div>
    <div class="flex items-center gap-3">
      <button *ngIf="!cajaAbierta()" pButton label="Abrir Caja" icon="pi pi-unlock" class="p-button-success" (click)="mostrarDialogoAbrirCaja = true"></button>
      <button *ngIf="cajaAbierta()" pButton label="Cerrar Caja" icon="pi pi-lock" class="p-button-danger" (click)="prepararCierreCaja()"></button>
      <button *ngIf="cajaAbierta()" pButton label="Arqueo" icon="pi pi-calculator" class="p-button-warning" (click)="mostrarDialogoArqueo = true"></button>
      <div *ngIf="cajaAbierta()" class="flex items-center gap-2 font-semibold px-3 py-1 rounded" style="background-color: color-mix(in srgb, var(--success-color) 15%, transparent); color: var(--success-color-text);">
        <i class="pi pi-check-circle"></i> Caja Abierta
      </div>
      <div *ngIf="!cajaAbierta()" class="flex items-center gap-2 font-semibold px-3 py-1 rounded" style="background-color: color-mix(in srgb, var(--danger-color) 15%, transparent); color: var(--danger-color-text);">
        <i class="pi pi-times-circle"></i> Caja Cerrada
      </div>
    </div>
  </div>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="grid gap-4 lg:grid-cols-3">

    <!-- PANEL IZQUIERDO: Productos y Servicios -->
    <div class="lg:col-span-2 flex flex-col gap-4">
      <!-- Filtros -->
      <div class="flex gap-3">
        <p-select [options]="categorias" [(ngModel)]="categoriaSeleccionada"
                  optionLabel="name" optionValue="value"
                  placeholder="Todas las categor√≠as"
                  (onChange)="filtrarItems()" class="flex-1" [disabled]="cargandoDatos"></p-select>
        <input pInputText [(ngModel)]="busqueda" placeholder="Buscar..." (input)="filtrarItems()" class="flex-1" [disabled]="cargandoDatos">
        <button pButton [icon]="vistaCompacta ? 'pi pi-th-large' : 'pi pi-list'"
                [class]="vistaCompacta ? 'p-button-success' : 'p-button-outlined'"
                (click)="vistaCompacta = !vistaCompacta"
                [pTooltip]="vistaCompacta ? 'Vista normal' : 'Vista compacta'"
                [disabled]="cargandoDatos"></button>
        <button pButton icon="pi pi-qrcode" [class]="modoScanner ? 'p-button-success' : 'p-button-outlined'" (click)="modoScanner = !modoScanner" pTooltip="Scanner (Ctrl+B)" [disabled]="cargandoDatos"></button>
        <button pButton icon="pi pi-refresh" (click)="cargarDatos()" [loading]="cargandoDatos" pTooltip="Recargar datos" class="p-button-outlined"></button>
      </div>

      <!-- Scanner de C√≥digo de Barras -->
      <div *ngIf="modoScanner" class="flex gap-2 p-3 rounded" style="background-color: color-mix(in srgb, var(--primary-color) 10%, transparent);">
        <input pInputText [(ngModel)]="codigoBarras" placeholder="Escanear c√≥digo de barras..."
               (keyup.enter)="buscarPorCodigoBarras()" class="flex-1" autofocus>
        <button pButton label="Buscar" icon="pi pi-search" (click)="buscarPorCodigoBarras()" class="p-button-success"></button>
      </div>

      <!-- Tabs Servicios/Productos -->
      <div class="flex" style="border-bottom: 1px solid var(--surface-border);">
        <button pButton 
                label="Servicios" 
                (click)="tipoActivo='services'; filtrarItems()"
                [severity]="tipoActivo==='services' ? 'info' : 'secondary'"
                [outlined]="tipoActivo!=='services'"
                [text]="true"
                class="border-b-2"
                [style]="tipoActivo==='services' ? 'border-bottom-color: var(--primary-color)' : 'border-bottom-color: transparent'"></button>
        <button pButton 
                label="Productos" 
                (click)="tipoActivo='products'; filtrarItems()"
                [severity]="tipoActivo==='products' ? 'info' : 'secondary'"
                [outlined]="tipoActivo!=='products'"
                [text]="true"
                class="border-b-2"
                [style]="tipoActivo==='products' ? 'border-bottom-color: var(--primary-color)' : 'border-bottom-color: transparent'"></button>
      </div>

      <!-- GRID DE ITEMS -->
      <div *ngIf="!cargandoDatos; else loadingTemplate">

        <!-- Vista Normal (Tarjetas) -->
        <div *ngIf="!vistaCompacta" class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
          <div *ngFor="let item of itemsFiltrados"
               class="p-4 rounded-lg shadow transition border-2"
               style="background-color: var(--surface-card); border-color: transparent;"
               [class.hover:shadow-lg]="puedeAgregarMas(item)"
               [class.cursor-pointer]="puedeAgregarMas(item)"
               [class.opacity-50]="!puedeAgregarMas(item)"
               [class.cursor-not-allowed]="!puedeAgregarMas(item)"
               [style.border-color]="puedeAgregarMas(item) ? 'color-mix(in srgb, var(--success-color) 30%, transparent)' : 'transparent'"
               (click)="puedeAgregarMas(item) && agregarAlCarrito(item)">
            <img *ngIf="item.image" [src]="item.image" [alt]="item.name" class="w-full h-32 object-cover rounded mb-2">
            <div class="flex justify-between items-start mb-2">
              <h6 class="font-semibold">{{ item.name }}</h6>
              <span class="text-lg font-bold" style="color: var(--primary-color);">{{ formatearMoneda(item.price) }}</span>
            </div>
            <p class="text-sm mb-2" style="color: var(--text-color-secondary);" *ngIf="item.description">{{ item.description }}</p>
            <div class="flex justify-between items-center">
              <span class="text-xs px-2 py-1 rounded" style="background-color: var(--surface-100); color: var(--text-color-secondary);">{{ item.category || 'General' }}</span>
              <div *ngIf="tipoActivo==='products'" class="text-xs">
                <span [style.color]="obtenerStockDisponible(item) > 5 ? 'var(--success-color-text)' : obtenerStockDisponible(item) > 0 ? 'var(--warning-color-text)' : 'var(--danger-color-text)'">
                  Stock: {{ obtenerStockDisponible(item) }}
                </span>
                <span *ngIf="obtenerStockDisponible(item) === 0" class="ml-1 font-semibold" style="color: var(--danger-color-text);">AGOTADO</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Vista Compacta (Lista) -->
        <div *ngIf="vistaCompacta" class="rounded-lg shadow overflow-hidden" style="background-color: var(--surface-card);">
          <div class="divide-y" style="border-color: var(--surface-border);">
            <div *ngFor="let item of itemsFiltrados"
                 class="flex items-center p-3 transition-colors"
                 [class.cursor-pointer]="puedeAgregarMas(item)"
                 [class.opacity-50]="!puedeAgregarMas(item)"
                 [class.cursor-not-allowed]="!puedeAgregarMas(item)"
                 [style.background-color]="puedeAgregarMas(item) ? 'var(--surface-hover)' : 'transparent'"
                 (click)="puedeAgregarMas(item) && agregarAlCarrito(item)">

              <!-- Icono de tipo -->
              <div class="shrink-0 w-10 h-10 rounded-full flex items-center justify-center mr-3"
                   [style.background-color]="tipoActivo === 'services' ? 'color-mix(in srgb, var(--success-color) 15%, transparent)' : 'color-mix(in srgb, var(--primary-color) 15%, transparent)'"
                   [style.color]="tipoActivo === 'services' ? 'var(--success-color-text)' : 'var(--primary-color-text)'">
                <i [class]="tipoActivo === 'services' ? 'pi pi-cut' : 'pi pi-box'" class="text-sm"></i>
              </div>

              <!-- Informaci√≥n principal -->
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                  <h6 class="font-semibold text-sm truncate">{{ item.name }}</h6>
                  <!-- Indicador de empleado requerido para servicios -->
                  <span *ngIf="tipoActivo === 'services'"
                        class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                        style="background-color: color-mix(in srgb, var(--warning-color) 15%, transparent); color: var(--warning-color-text);">
                    <i class="pi pi-user text-xs mr-1"></i>Empleado
                  </span>
                </div>
                <div class="flex items-center gap-3 text-xs" style="color: var(--text-color-secondary);">
                  <span class="px-2 py-1 rounded" style="background-color: var(--surface-100);">{{ item.category || 'General' }}</span>
                  <span *ngIf="tipoActivo === 'products'"
                        [style.color]="obtenerStockDisponible(item) > 5 ? 'var(--success-color-text)' : obtenerStockDisponible(item) > 0 ? 'var(--warning-color-text)' : 'var(--danger-color-text)'">
                    Stock: {{ obtenerStockDisponible(item) }}
                  </span>
                </div>
              </div>

              <!-- Precio -->
              <div class="shrink-0 text-right">
                <span class="text-lg font-bold" style="color: var(--primary-color);">{{ formatearMoneda(item.price) }}</span>
                <div *ngIf="tipoActivo === 'products' && obtenerStockDisponible(item) === 0"
                     class="text-xs font-semibold" style="color: var(--danger-color-text);">AGOTADO</div>
              </div>

              <!-- Bot√≥n de agregar -->
              <div class="shrink-0 ml-3">
                <button *ngIf="puedeAgregarMas(item)"
                        pButton icon="pi pi-plus"
                        size="small"
                        severity="info"
                        [rounded]="true"
                        (click)="$event.stopPropagation(); agregarAlCarrito(item)"
                        [pTooltip]="'Agregar ' + item.name"></button>
              </div>
            </div>
          </div>
        </div>

        <!-- Mensaje cuando no hay items -->
        <div *ngIf="itemsFiltrados.length === 0" class="text-center py-8">
          <i class="pi pi-search text-4xl mb-4" style="color: var(--text-color-secondary);"></i>
          <p style="color: var(--text-color-secondary);">No se encontraron {{ tipoActivo === 'services' ? 'servicios' : 'productos' }}</p>
          <button pButton label="Limpiar filtros" (click)="categoriaSeleccionada=''; busqueda=''; filtrarItems()" class="p-button-text mt-2"></button>
        </div>
      </div>

      <ng-template #loadingTemplate>
        <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
          <div *ngFor="let i of [1,2,3,4,5,6]" class="p-4 rounded-lg shadow animate-pulse" style="background-color: var(--surface-card);">
            <div class="h-4 rounded mb-2" style="background-color: var(--surface-200);"></div>
            <div class="h-3 rounded mb-2 w-3/4" style="background-color: var(--surface-200);"></div>
            <div class="h-3 rounded w-1/2" style="background-color: var(--surface-200);"></div>
          </div>
        </div>
      </ng-template>

      <!-- CARRITO -->
      <div *ngIf="carrito().length>0" class="mt-4 p-4 rounded-lg shadow-inner" style="background-color: var(--surface-ground);">
        <h5 class="font-bold mb-3 text-lg">Carrito</h5>
        <div class="flex flex-col gap-2">
          <div *ngFor="let item of carrito(); let i=index" class="flex justify-between items-center p-2 rounded-lg shadow" style="background-color: var(--surface-card);">
            <div class="flex-1">
              <h6 class="font-medium">{{ item.item.name }}</h6>
              <p class="text-sm m-0" style="color: var(--text-color-secondary);">{{ item.type==='service'?'Servicio':'Producto' }}</p>
            </div>
            <div class="flex items-center gap-3">
              <div class="flex items-center gap-1">
                <button pButton icon="pi pi-minus" size="small" (click)="cambiarCantidad(i,-1)" [text]="true"></button>
                <span class="font-medium">{{ item.quantity }}</span>
                <button pButton icon="pi pi-plus" size="small" (click)="cambiarCantidad(i,1)" [text]="true"></button>
              </div>
              <span class="font-bold" style="color: var(--primary-color);">\${{ item.subtotal.toFixed(2) }}</span>
              <button pButton icon="pi pi-trash" severity="danger" size="small" (click)="removerDelCarrito(i)" [text]="true"></button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PANEL DERECHO: Resumen -->
    <div class="flex flex-col gap-4 sticky top-4">
      <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow flex flex-col gap-4">

        <h5 class="font-bold text-lg">Resumen de Venta</h5>

        <!-- Cliente -->
        <div>
          <label class="block font-medium mb-1">Cliente</label>
          <p-select [options]="clientes" [(ngModel)]="clienteSeleccionado"
                    optionLabel="full_name" placeholder="Cliente general"
                    [showClear]="true" class="w-full"
                    (onChange)="aplicarDescuentoClienteFrecuente()">
            <ng-template pTemplate="item" let-cliente>
              <div class="flex items-center justify-between w-full">
                <span>{{ cliente.full_name }}</span>
                <span *ngIf="esClienteFrecuente(cliente)" class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
                  ‚≠ê VIP
                </span>
              </div>
            </ng-template>
          </p-select>
        </div>

        <!-- Empleado -->
        <div *ngIf="tieneServicios()">
          <label class="block font-medium mb-1">Empleado ({{ empleados.length }} disponibles)</label>
          <p-select [options]="empleados" [ngModel]="empleadoSeleccionado()" (ngModelChange)="empleadoSeleccionado.set($event)"
                    optionLabel="displayName"
                    placeholder="Seleccionar empleado"
                    class="w-full">
            <ng-template pTemplate="item" let-empleado>
              <div class="flex items-center gap-2">
                <i class="pi pi-user text-primary-500"></i>
                <span>{{ empleado?.displayName || empleado?.name || 'Sin nombre' }}</span>
              </div>
            </ng-template>
          </p-select>
        </div>

        <!-- Totales -->
        <div class="p-3 bg-gray-50 dark:bg-gray-900 rounded-lg">
          <div class="flex justify-between mb-2"><span>Subtotal:</span><span class="font-semibold">{{ formatearMoneda(calcularSubtotal()) }}</span></div>
          <div class="flex justify-between mb-2">
            <span>Descuento:</span>
            <div class="flex items-center gap-2">
              <input type="number" pInputText [(ngModel)]="descuento" class="w-16 text-right" min="0" [max]="tipoDescuento === '%' ? 100 : calcularSubtotal()">
              <button pButton [label]="tipoDescuento" size="small" class="p-button-outlined w-8" (click)="alternarTipoDescuento()"></button>
            </div>
          </div>
          <hr class="my-2 border-gray-300 dark:border-gray-700">
          <div class="flex justify-between font-bold text-lg"><span>Total:</span><span class="text-primary-600">{{ formatearMoneda(calcularTotal()) }}</span></div>
        </div>

        <!-- M√©todo de pago -->
        <div>
          <label class="block font-medium mb-1">M√©todo de Pago</label>
          <p-select [options]="metodosPago" [ngModel]="metodoPagoSeleccionado()" (ngModelChange)="metodoPagoSeleccionado.set($event)" optionLabel="label" optionValue="value" placeholder="Seleccionar m√©todo" class="w-full"></p-select>
        </div>


        <!-- Botones -->
        <div class="flex flex-col gap-2">
          <button pButton
                  [label]="procesandoVenta ? 'Procesando...' : (puedeVenderComputed() ? 'Procesar Venta' : obtenerMensajeValidacion())"
                  [icon]="procesandoVenta ? 'pi pi-spin pi-spinner' : 'pi pi-check'"
                  [disabled]="!puedeVenderComputed() || procesandoVenta"
                  [loading]="procesandoVenta"
                  (click)="procesarVenta()"
                  class="p-button-success w-full"
                  [pTooltip]="!puedeVenderComputed() ? obtenerMensajeValidacion() : ''"></button>
          <button pButton label="Limpiar" icon="pi pi-trash" (click)="limpiarCarrito()" class="p-button-outlined w-full" [disabled]="carrito().length === 0 || procesandoVenta"></button>
          <button pButton label="Historial" icon="pi pi-history" (click)="mostrarDialogoHistorial=true; cargarHistorialVentas()" class="p-button-outlined w-full" size="small" [disabled]="procesandoVenta"></button>
        </div>

        <!-- Estad√≠sticas -->
        <div class="p-3 bg-blue-50 dark:bg-blue-900 rounded-lg">
          <h6 class="text-blue-800 dark:text-blue-300 mb-2">Estad√≠sticas del D√≠a</h6>
          <div class="flex justify-between text-sm"><span>Ventas:</span><span class="font-semibold">{{ estadisticasDia().ventas }}</span></div>
          <div class="flex justify-between text-sm"><span>Ingresos:</span><span class="font-semibold text-green-600 dark:text-green-400">{{ formatearMoneda(estadisticasDia().ingresos) }}</span></div>
          <div class="flex justify-between text-sm"><span>Ticket Promedio:</span><span class="font-semibold">{{ formatearMoneda(estadisticasDia().ticketPromedio) }}</span></div>
        </div>

        <!-- Pagos NO en Efectivo (Solo Informativo) -->
        <div *ngIf="pagosNoCash().length > 0" class="p-3 bg-amber-50 dark:bg-amber-900 rounded-lg border border-amber-200">
          <h6 class="text-amber-800 dark:text-amber-300 mb-2 flex items-center gap-2">
            <i class="pi pi-info-circle"></i>
            Ingresos por Otros M√©todos
          </h6>
          <div *ngFor="let pago of pagosNoCash()" class="flex justify-between text-sm mb-1">
            <span>{{ pago.payment_method }}:</span>
            <span class="font-semibold text-amber-700">{{ formatearMoneda(pago.total) }}</span>
          </div>
          <div class="text-xs text-amber-700 mt-2 p-2 bg-amber-100 rounded border-l-4 border-amber-400">
            <i class="pi pi-exclamation-triangle mr-1"></i>
            <strong>Nota:</strong> Estos montos NO afectan el arqueo de caja
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- DIALOGS Y TOAST -->
  <p-dialog header="Abrir Caja" [(visible)]="mostrarDialogoAbrirCaja" [modal]="true" [style]="{width:'400px'}">
    <div class="flex flex-col gap-3">
      <label class="font-medium">Monto Inicial</label>
      <p-inputNumber [(ngModel)]="montoInicialCaja" mode="currency" currency="USD" locale="en-US" class="w-full"></p-inputNumber>
      <div class="flex justify-end gap-2">
        <button pButton label="Cancelar" (click)="mostrarDialogoAbrirCaja=false" class="p-button-text"></button>
        <button pButton label="Abrir Caja" (click)="abrirCaja()" class="p-button-success"></button>
      </div>
    </div>
  </p-dialog>

  <p-dialog header="Cuadre y Cierre de Caja" [(visible)]="mostrarDialogoCerrarCaja" [modal]="true" [style]="{width:'500px'}">
    <div class="flex flex-col gap-4">
      <div class="p-3 bg-gray-50 rounded">
        <h5 class="font-bold mb-2">üß¶ Resumen del D√≠a - Solo Efectivo</h5>
        <div class="flex justify-between text-sm">
          <span>Monto inicial:</span>
          <span class="font-mono">${{ (montoEsperado - ventasEfectivoHoy).toFixed(2) }}</span>
        </div>
        <div class="flex justify-between text-sm">
          <span>Ventas en efectivo:</span>
          <span class="font-mono">${{ ventasEfectivoHoy.toFixed(2) }}</span>
        </div>
        <div class="flex justify-between text-sm font-bold border-t pt-1">
          <span>Efectivo esperado:</span>
          <span class="font-mono">${{ (+montoEsperado || 0).toFixed(2) }}</span>
        </div>
      </div>

      <!-- Pagos NO en Efectivo (Solo Informativo) -->
      <div *ngIf="pagosNoCash().length > 0" class="p-3 bg-blue-50 rounded border border-blue-200">
        <h5 class="font-bold mb-2 text-blue-800 flex items-center gap-2">
          <i class="pi pi-info-circle"></i>
          üìä Ingresos por Otros M√©todos
        </h5>
        <div *ngFor="let pago of pagosNoCash()" class="flex justify-between text-sm mb-1">
          <span>{{ pago.payment_method }}:</span>
          <span class="font-mono text-blue-700">${{ pago.total.toFixed(2) }}</span>
        </div>
        <div class="text-xs text-blue-700 mt-2 p-2 bg-blue-100 rounded border-l-4 border-blue-400">
          <i class="pi pi-shield mr-1"></i>
          <strong>Importante:</strong> Estos montos NO se incluyen en el arqueo de caja f√≠sico
        </div>
      </div>

      <div>
        <label class="font-medium block mb-2">Efectivo contado en caja:</label>
        <p-inputNumber [(ngModel)]="montoFinalCaja"
                       mode="currency" currency="USD" locale="en-US"
                       class="w-full"
                       (onInput)="calcularDiferencia()"></p-inputNumber>
      </div>

      <div class="p-3 rounded" [class]="Math.abs(diferenciaCaja) > 5 ? 'bg-red-50 border border-red-200' : 'bg-green-50 border border-green-200'">
        <div class="flex justify-between font-bold">
          <span>Diferencia:</span>
          <span class="font-mono" [class]="diferenciaCaja >= 0 ? 'text-green-600' : 'text-red-600'">
            {{ diferenciaCaja >= 0 ? '+' : '' }}${{ diferenciaCaja.toFixed(2) }}
          </span>
        </div>
        <div class="text-xs mt-2" [class]="Math.abs(diferenciaCaja) > 5 ? 'text-red-700' : 'text-green-700'">
          <p *ngIf="diferenciaCaja > 5">
            ‚ÑπÔ∏è Sobra dinero: Verifique si hay ingresos no registrados o errores de conteo
          </p>
          <p *ngIf="diferenciaCaja < -5">
            ‚ö†Ô∏è Falta dinero: Revise gastos no registrados o posibles errores de conteo
          </p>
          <p *ngIf="Math.abs(diferenciaCaja) <= 5">
            ‚úÖ Diferencia aceptable: El cuadre est√° dentro del rango normal
          </p>
          <p class="mt-1 font-medium">
            üîç Debe verificar y confirmar antes de cerrar la caja
          </p>
        </div>
      </div>

      <div class="flex justify-end gap-2">
        <button pButton label="Cancelar" (click)="mostrarDialogoCerrarCaja=false" class="p-button-text"></button>
        <button pButton label="Cerrar Caja" (click)="cerrarCaja()"
                [class]="Math.abs(diferenciaCaja) > 5 ? 'p-button-danger' : 'p-button-success'"></button>
      </div>
    </div>
  </p-dialog>

  <!-- DI√ÅLOGO DE TICKET PROFESIONAL -->
  <p-dialog [(visible)]="mostrarDialogoTicket" [modal]="true" [style]="{width:'420px'}" [closable]="false" [showHeader]="false">
    <div class="ticket-profesional" *ngIf="ventaActual">
      <!-- Header elegante -->
      <div class="ticket-header">
        <div class="logo-section">
          <div class="logo-placeholder">‚úÇÔ∏è</div>
          <h1 class="business-name">BARBER√çA ELEGANTE</h1>
          <p class="business-tagline">Estilo y Tradici√≥n</p>
        </div>
        <div class="business-info">
          <p>üìç Av. Principal #123, Centro</p>
          <p>üìû (555) 123-4567</p>
          <p>üåê www.barberiaelegante.com</p>
          <p>üìß info@barberiaelegante.com</p>
        </div>
        <div class="separator"></div>
      </div>

      <!-- Info de transacci√≥n -->
      <div class="transaction-info">
        <div class="info-row">
          <span class="label">TICKET #</span>
          <span class="value">{{ ventaActual.id.toString().padStart(6, '0') }}</span>
        </div>
        <div class="info-row">
          <span class="label">FECHA</span>
          <span class="value">{{ getCurrentDateTime().split(',')[0] }}</span>
        </div>
        <div class="info-row">
          <span class="label">HORA</span>
          <span class="value">{{ getCurrentDateTime().split(',')[1] }}</span>
        </div>
        <div class="info-row" *ngIf="ventaActual.client">
          <span class="label">CLIENTE</span>
          <span class="value"> ID {{ ventaActual.client }}</span>
        </div>
        <div class="info-row" *ngIf="ventaActual.employee_name">
          <span class="label">BARBERO</span>
          <span class="value">{{ ventaActual.employee_name }}</span>
        </div>
      </div>
      <div class="separator"></div>

      <!-- Items vendidos -->
      <div class="items-section">
        <div class="items-header">
          <span class="col-desc">DESCRIPCI√ìN</span>
          <span class="col-qty">CANT</span>
          <span class="col-price">PRECIO</span>
          <span class="col-total">TOTAL</span>
        </div>
        <div class="separator-thin"></div>
        <div *ngFor="let item of ventaActual.details" class="item-row">
          <div class="item-desc">
            <span class="item-name">{{ item.item?.name || item.name }}</span>
            <span class="item-type">{{ item.type === 'service' ? 'üîß Servicio' : 'üì¶ Producto' }}</span>
          </div>
          <span class="item-qty">{{ item.quantity }}</span>
          <span class="item-price">{{ formatearMoneda(item.price) }}</span>
          <span class="item-total">{{ formatearMoneda(item.subtotal) }}</span>
        </div>
      </div>
      <div class="separator"></div>

    <!-- Totales -->
<div class="totals-section">
  <div class="total-row">
    <span class="total-label">SUBTOTAL</span>
    <span class="total-value">
      {{ formatearMoneda(getSubtotal(ventaActual)) }}
    </span>
  </div>

  <div class="total-row" *ngIf="ventaActual.discount > 0">
    <span class="total-label">DESCUENTO</span>
    <span class="total-value discount">
      -{{ formatearMoneda(ventaActual.discount) }}
    </span>
  </div>

  <div class="separator-thin"></div>

  <div class="total-row final">
    <span class="total-label">TOTAL PAGADO</span>
    <span class="total-value">
      {{ formatearMoneda(ventaActual.total) }}
    </span>
  </div>

  <div class="payment-info">
    <span class="payment-method">
      üí≥ {{ getPaymentMethodName(ventaActual.payment_method) }}
    </span>
  </div>
</div>

      <!-- Firma del cliente -->
      <div *ngIf="firmaCliente" class="signature-section">
        <div class="separator"></div>
        <p class="signature-label">Firma del cliente:</p>
        <img [src]="firmaCliente" class="signature-image">
      </div>

      <!-- C√≥digo QR -->
      <div class="qr-section">
        <div class="separator"></div>
        <div class="qr-container">
          <canvas #qrCanvas width="80" height="80" class="qr-code"></canvas>
        </div>
        <p class="qr-label">Escanea para ver detalles</p>
      </div>

      <!-- Footer profesional -->
      <div class="separator"></div>
      <div class="footer-section">
        <div class="thank-you">
          <p class="main-message">¬°GRACIAS POR SU VISITA!</p>
          <p class="sub-message">Su satisfacci√≥n es nuestra prioridad</p>
        </div>
        <div class="footer-info">
          <p>‚≠ê S√≠guenos en redes sociales</p>
          <p>üì± Descarga nuestra app</p>
          <p>üéÅ Programa de fidelidad disponible</p>
        </div>
        <div class="legal-info">
          <p>RUC: 20123456789</p>
          <p>Autorizado por SUNAT</p>
        </div>
      </div>
    </div>

    <!-- Botones del ticket -->
    <div class="ticket-actions">
      <button pButton label="Imprimir" icon="pi pi-print" (click)="imprimirTicket()" class="p-button-outlined flex-1"></button>
      <button pButton label="Cerrar" icon="pi pi-times" (click)="cerrarTicket()" class="p-button-success flex-1"></button>
    </div>
  </p-dialog>

  <!-- DI√ÅLOGO DE PAGO EFECTIVO -->
  <p-dialog header="Pago en Efectivo" [(visible)]="mostrarDialogoPago" [modal]="true" [style]="{width:'400px'}">
    <div class="flex flex-col gap-4">
      <div class="p-3 bg-gray-50 rounded">
        <div class="flex justify-between text-lg font-bold">
          <span>Total a pagar:</span>
          <span class="text-primary-600">{{ formatearMoneda(calcularTotal()) }}</span>
        </div>
      </div>

      <div>
        <label class="font-medium block mb-2">Monto recibido:</label>
        <p-inputNumber [(ngModel)]="montoRecibido"
                       mode="currency" currency="USD" locale="en-US"
                       class="w-full"
                       (onInput)="cambio = calcularCambio()"></p-inputNumber>
      </div>

      <div class="p-3 rounded" [class]="validarMontoRecibido() ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
        <div class="flex justify-between font-bold">
          <span>Cambio:</span>
          <span class="font-mono" [class]="cambio >= 0 ? 'text-green-600' : 'text-red-600'">
            {{ formatearMoneda(calcularCambio()) }}
          </span>
        </div>
      </div>

      <div class="flex justify-end gap-2">
        <button pButton label="Cancelar" (click)="mostrarDialogoPago=false" class="p-button-text"></button>
        <button pButton label="Confirmar Pago"
                (click)="confirmarVenta()"
                [disabled]="!validarMontoRecibido()"
                class="p-button-success"></button>
      </div>
    </div>
  </p-dialog>

  <!-- DI√ÅLOGO DE ARQUEO -->
  <p-dialog header="Arqueo de Caja (Solo Consulta)" [(visible)]="mostrarDialogoArqueo" [modal]="true" [style]="{width:'500px'}">
    <div class="flex flex-col gap-4">
      <p class="text-sm text-gray-600 mb-3">üí° Este arqueo es solo para consulta. El cuadre oficial se hace al cerrar caja.</p>

      <div *ngFor="let denom of denominaciones; trackBy: trackByDenominacion" class="flex items-center gap-3">
        <span class="w-16 font-mono">${{ denom.valor }}</span>
        <input type="number" pInputText [(ngModel)]="denom.cantidad" min="0" class="w-20" (input)="denom.total = denom.valor * denom.cantidad">
        <span class="w-24 text-right font-mono">${{ denom.total.toFixed(2) }}</span>
      </div>

      <div class="border-t pt-3">
        <div class="flex justify-between font-bold text-lg">
          <span>Total contado:</span>
          <span class="font-mono">${{ calcularTotalArqueo().toFixed(2) }}</span>
        </div>
        <div class="flex justify-between text-sm text-gray-600 mt-2">
          <span>Efectivo esperado:</span>
          <span class="font-mono">${{ (obtenerMontoInicialCaja() + ventasEfectivoSesionActual).toFixed(2) }}</span>
        </div>
        <div class="flex justify-between font-semibold mt-1" [class]="calcularDiferenciaArqueo() >= 0 ? 'text-green-600' : 'text-red-600'">
          <span>Diferencia:</span>
          <span class="font-mono">{{ calcularDiferenciaArqueo() >= 0 ? '+' : '' }}${{ calcularDiferenciaArqueo().toFixed(2) }}</span>
        </div>
      </div>

      <div class="flex justify-end gap-2">
        <button pButton label="Limpiar" (click)="limpiarArqueo()" class="p-button-outlined"></button>
        <button pButton label="Cerrar" (click)="mostrarDialogoArqueo=false" class="p-button-success"></button>
      </div>
    </div>
  </p-dialog>

  <!-- DI√ÅLOGO DE HISTORIAL -->
  <p-dialog header="Historial de Ventas (√öltimos 7 d√≠as)" [(visible)]="mostrarDialogoHistorial" [modal]="true" [style]="{width:'800px'}">
    <div class="flex flex-col gap-4">
      <div *ngIf="cargandoHistorial" class="text-center p-4">
        <i class="pi pi-spin pi-spinner text-2xl"></i>
        <p>Cargando historial...</p>
      </div>
      <div *ngIf="!cargandoHistorial && historialVentas.length === 0" class="text-center p-4">
        <p>No hay ventas registradas</p>
      </div>
      <div *ngIf="!cargandoHistorial && historialVentas.length > 0" class="max-h-96 overflow-y-auto">
        <div *ngFor="let venta of historialVentas" class="border rounded p-3 mb-2 hover:bg-gray-50">
          <div class="flex justify-between items-center">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <strong>Venta #{{ venta.id }}</strong>
                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">{{ getPaymentMethodName(venta.payment_method) }}</span>
              </div>
              <p class="text-sm text-gray-600">{{ venta.date_time | date:'dd/MM/yyyy HH:mm' }}</p>
              <p class="text-sm text-gray-600" *ngIf="venta.client">Cliente: {{ venta.client }}</p>
            </div>

            <div class="text-right">
              <div class="font-bold text-lg">${{ venta.total }}</div>
            </div>

            <div class="flex gap-1 ml-4">
              <button pButton icon="pi pi-eye" size="small"
                      (click)="visualizarVenta(venta)" pTooltip="Ver detalles"></button>
              <button pButton icon="pi pi-print" size="small"
                      (click)="reimprimirTicket(venta)" pTooltip="Reimprimir"></button>
            </div>
          </div>
        </div>
      </div>
      <div class="flex justify-end">
        <button pButton label="Cerrar" (click)="mostrarDialogoHistorial=false" class="p-button-text"></button>
      </div>
    </div>
  </p-dialog>

  <!-- DI√ÅLOGO DE PROMOCIONES -->
  <p-dialog header="Promociones Disponibles" [(visible)]="mostrarDialogoPromociones" [modal]="true" [style]="{width:'600px'}">
    <div class="flex flex-col gap-4">
      <div *ngIf="promociones.length === 0" class="text-center p-4">
        <p>No hay promociones disponibles</p>
      </div>
      <div *ngFor="let promocion of promociones" class="border rounded p-3">
        <div class="flex justify-between items-center">
          <div>
            <h4 class="font-bold">{{ promocion.name }}</h4>
            <p class="text-sm text-gray-600">{{ promocion.description }}</p>
            <div class="text-sm">
              <span *ngIf="promocion.type === 'percentage'">{{ promocion.discount_value }}% descuento</span>
              <span *ngIf="promocion.type === 'fixed'">${{ promocion.discount_value }} descuento</span>
              <span *ngIf="promocion.min_amount > 0"> - M√≠nimo ${{ promocion.min_amount }}</span>
            </div>
          </div>
          <button pButton label="Aplicar" (click)="aplicarPromocion(promocion)" class="p-button-success"></button>
        </div>
      </div>
      <div class="flex justify-end">
        <button pButton label="Cerrar" (click)="mostrarDialogoPromociones=false" class="p-button-text"></button>
      </div>
    </div>
  </p-dialog>

  <!-- DI√ÅLOGO DE FIRMA -->
  <p-dialog header="Firma del Cliente" [(visible)]="mostrarDialogoFirma" [modal]="true" [style]="{width:'500px'}">
    <div class="flex flex-col gap-4">
      <p>Por favor, solicite al cliente que firme en el recuadro:</p>
      <div class="border-2 border-gray-300 rounded">
        <canvas #firmaCanvas
                width="450"
                height="200"
                class="cursor-crosshair"
                (mousedown)="iniciarFirma($event)"
                (mousemove)="dibujarFirma($event)"
                (mouseup)="terminarFirma()"
                (mouseleave)="terminarFirma()"></canvas>
      </div>
      <div class="flex justify-between">
        <button pButton label="Limpiar" icon="pi pi-eraser" (click)="limpiarFirma()" class="p-button-outlined"></button>
        <div class="flex gap-2">
          <button pButton label="Omitir" (click)="mostrarDialogoFirma=false; confirmarVenta()" class="p-button-text"></button>
          <button pButton label="Confirmar" (click)="confirmarFirma()" class="p-button-success"></button>
        </div>
      </div>
    </div>
  </p-dialog>

  <p-toast></p-toast>
</div>

<!-- Estilos profesionales para ticket -->
<style>
.ticket-profesional {
  font-family: 'Courier New', monospace;
  width: 100%;
  max-width: 380px;
  margin: 0 auto;
  background: white;
  color: #000;
  line-height: 1.4;
}

.ticket-header { text-align: center; margin-bottom: 16px; }
.logo-placeholder { font-size: 32px; margin-bottom: 8px; }
.business-name { font-size: 18px; font-weight: bold; margin: 0; letter-spacing: 1px; }
.business-tagline { font-size: 12px; margin: 4px 0; font-style: italic; color: #666; }
.business-info { font-size: 11px; line-height: 1.3; margin: 8px 0; }
.business-info p { margin: 2px 0; }
.separator { border-top: 2px dashed #000; margin: 12px 0; }
.separator-thin { border-top: 1px solid #ccc; margin: 8px 0; }
.transaction-info { margin-bottom: 16px; }
.info-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px; }
.label { font-weight: bold; }
.value { font-family: 'Courier New', monospace; }
.items-header { display: grid; grid-template-columns: 2fr 0.5fr 1fr 1fr; gap: 8px; font-size: 10px; font-weight: bold; margin-bottom: 8px; text-align: center; }
.col-desc { text-align: left; }
.item-row { display: grid; grid-template-columns: 2fr 0.5fr 1fr 1fr; gap: 8px; margin-bottom: 6px; font-size: 11px; align-items: center; }
.item-desc { text-align: left; }
.item-name { display: block; font-weight: bold; }
.item-type { display: block; font-size: 9px; color: #666; }
.item-qty, .item-price, .item-total { text-align: right; font-family: 'Courier New', monospace; }
.total-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px; }
.total-row.final { font-size: 14px; font-weight: bold; border-top: 2px solid #000; padding-top: 4px; margin-top: 8px; }
.total-value { font-family: 'Courier New', monospace; }
.discount { color: #e74c3c; }
.payment-info { text-align: center; margin-top: 8px; font-size: 11px; background: #f8f9fa; padding: 4px; border-radius: 4px; }
.signature-section { text-align: center; margin: 16px 0; }
.signature-image { max-width: 200px; height: 60px; border: 1px solid #ccc; margin: 0 auto; display: block; }
.qr-section { text-align: center; margin: 16px 0; }
.qr-container { display: inline-block; padding: 8px; background: white; border: 1px solid #ccc; }
.footer-section { text-align: center; margin-top: 16px; }
.main-message { font-size: 14px; font-weight: bold; margin: 0; }
.sub-message { font-size: 10px; margin: 4px 0; color: #666; }
.footer-info { font-size: 9px; margin: 8px 0; line-height: 1.3; }
.footer-info p { margin: 2px 0; }
.legal-info { font-size: 8px; color: #999; margin-top: 8px; }
.ticket-actions { display: flex; gap: 8px; margin-top: 16px; }

@media print {
  body * { visibility: hidden; }
  .ticket-profesional, .ticket-profesional * { visibility: visible; }
  .ticket-profesional { position: absolute; left: 0; top: 0; width: 80mm; font-size: 10px; }
  .ticket-actions { display: none; }
}
</style>
