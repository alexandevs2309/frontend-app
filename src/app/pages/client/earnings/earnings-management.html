<div class="min-h-screen bg-gray-50 dark:bg-gray-900 p-4 transition-colors">

  <!-- HEADER -->
  <div class="flex justify-between items-center bg-linear-to-r from-green-600 to-emerald-600 text-white rounded-lg p-6 shadow-lg mb-6">
    <div>
      <h1 class="text-3xl font-bold">üí∞ Ganancias del Negocio</h1>
      <p class="text-sm opacity-90">An√°lisis de rentabilidad y rendimiento financiero</p>
      <div *ngIf="cashRegisterData()" class="mt-2 text-xs opacity-75">
        üè¶ Caja Actual: {{ formatearMoneda(cashRegisterData()!.current_amount || 0) }}
      </div>
    </div>
    <div class="flex items-center gap-3">
      <button pButton label="Pagos Empleados" icon="pi pi-users" class="p-button-outlined"
              (click)="irAModuloPagos()" pTooltip="Ir al m√≥dulo de pagos"></button>
      <button pButton label="Excel" icon="pi pi-file-excel" class="p-button-success p-button-outlined"
              [loading]="loadingStates().export" (click)="exportarExcel()"></button>
      <button pButton label="PDF" icon="pi pi-file-pdf" class="p-button-danger p-button-outlined"
              [loading]="loadingStates().export" (click)="exportarPDF()"></button>
      <button pButton label="Sincronizar" icon="pi pi-sync" class="p-button-outlined"
              (click)="sincronizarConCaja()"></button>
    </div>
  </div>

  <!-- RESUMEN FINANCIERO DEL NEGOCIO -->
  <div class="grid gap-6 md:grid-cols-4 mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border-l-4 border-green-500 transition-colors">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600 dark:text-gray-300 font-medium">Ingresos Totales</p>
          <p class="text-2xl font-bold text-green-600">{{ formatearMoneda(resumenCalculado().totalIngresos) }}</p>
        </div>
        <div class="bg-green-100 p-3 rounded-full">
          <i class="pi pi-chart-line text-green-600 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border-l-4 border-red-500 transition-colors">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600 dark:text-gray-300 font-medium">Costos Totales</p>
          <p class="text-2xl font-bold text-red-600">{{ formatearMoneda(resumenCalculado().totalCostos) }}</p>
        </div>
        <div class="bg-red-100 p-3 rounded-full">
          <i class="pi pi-minus-circle text-red-600 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border-l-4 border-blue-500 transition-colors">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600 dark:text-gray-300 font-medium">Ganancia Neta</p>
          <p class="text-2xl font-bold text-blue-600">{{ formatearMoneda(resumenCalculado().gananciaNeta) }}</p>
        </div>
        <div class="bg-blue-100 p-3 rounded-full">
          <i class="pi pi-check-circle text-blue-600 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border-l-4 border-purple-500 transition-colors">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600 dark:text-gray-300 font-medium">Margen de Ganancia</p>
          <p class="text-2xl font-bold text-purple-600">{{ resumenCalculado().margenGanancia.toFixed(1) }}%</p>
        </div>
        <div class="bg-purple-100 p-3 rounded-full">
          <i class="pi pi-percentage text-purple-600 text-xl"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- NAVEGACI√ìN DE PER√çODOS -->
  <div class="bg-linear-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl p-6 border border-blue-200 dark:border-blue-700 mb-6 transition-colors">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <button pButton icon="pi pi-chevron-left" class="p-button-text p-button-sm"
                (click)="periodoAnterior()" pTooltip="Per√≠odo anterior"></button>
        <div class="text-center">
          <h3 class="font-semibold text-blue-800 dark:text-blue-200">{{ periodoSeleccionado().titulo }}</h3>
          <p class="text-blue-600 dark:text-blue-300 text-sm">{{ formatearRangoPeriodo(periodoSeleccionado()) }}</p>
        </div>
        <button pButton icon="pi pi-chevron-right" class="p-button-text p-button-sm"
                (click)="periodoSiguiente()" [disabled]="!puedeAvanzarPeriodo()" pTooltip="Per√≠odo siguiente"></button>
      </div>
      <div class="text-right">
        <p class="text-sm text-blue-600 dark:text-blue-300">Transacciones:</p>
        <p class="font-semibold text-blue-800 dark:text-blue-200">{{ resumenCalculado().totalTransacciones }}</p>
        <p class="text-xs text-blue-500 dark:text-blue-400">Promedio: {{ formatearMoneda(resumenCalculado().promedioTransaccion) }}</p>
        <button pButton label="Hoy" class="p-button-outlined p-button-sm mt-2"
                (click)="irAPeriodoActual()"></button>
      </div>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 mb-6 transition-colors">
    <h3 class="font-semibold mb-4 text-gray-800 dark:text-gray-200">üîç Filtros de An√°lisis</h3>
    <div class="grid gap-4 md:grid-cols-5">
      <div>
        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Frecuencia</label>
        <p-select [options]="frequencies" [ngModel]="frequencySelected()" placeholder="Frecuencia"
                  optionLabel="label" optionValue="value" class="w-full"
                  (onChange)="onFrequencyChange($event.value)"></p-select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Fecha Referencia</label>
        <p-datepicker [ngModel]="referenceDate()" [showIcon]="true"
                    placeholder="Fecha referencia" class="w-full"
                    (onSelect)="onReferenceDateChange($event)"></p-datepicker>
      </div>
      <div>
        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Servicio</label>
        <p-select [options]="categoriasServicios" placeholder="Todos los servicios"
                  optionLabel="label" optionValue="value" class="w-full"
                  (onChange)="aplicarFiltroServicio($event.value)"></p-select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Acciones R√°pidas</label>
        <button pButton label="An√°lisis Rentabilidad" icon="pi pi-chart-pie" class="w-full p-button-outlined"
                (click)="abrirAnalisisRentabilidad()"></button>
      </div>
      <div class="flex items-end">
        <button pButton label="Limpiar Filtros" icon="pi pi-times" class="p-button-outlined w-full"
                (click)="limpiarFiltros()"></button>
      </div>
    </div>
  </div>

  <!-- TABLA DE SERVICIOS -->
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm transition-colors">
    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
      <h3 class="font-semibold text-gray-800 dark:text-gray-200 text-lg">üìä Rendimiento por Servicio</h3>
    </div>

    <p-table [value]="serviciosFiltrados()" [loading]="loadingStates().main"
             [virtualScroll]="true" [virtualScrollItemSize]="60" [scrollHeight]="'400px'"
             [paginator]="true" [rows]="15" [showCurrentPageReport]="true"
             currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} servicios"
             [rowsPerPageOptions]="[15, 25, 50]" responsiveLayout="scroll" styleClass="p-datatable-sm">

      <ng-template pTemplate="header">
        <tr>
          <th>Servicio</th>
          <th>Ventas</th>
          <th>Ingresos</th>
          <th>Costos</th>
          <th>Ganancia</th>
          <th>Margen %</th>
          <th>Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-servicio>
        <tr>
          <td>
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                <i class="pi pi-shopping-cart text-blue-600"></i>
              </div>
              <div>
                <p class="font-medium text-gray-900 dark:text-gray-100">{{ servicio.service_name }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">{{ servicio.quantity_sold }} unidades vendidas</p>
              </div>
            </div>
          </td>
          <td>
            <div class="flex flex-col">
              <span class="font-semibold text-gray-900 dark:text-gray-100">{{ servicio.total_sales }}</span>
              <span class="text-xs text-gray-500 dark:text-gray-400">transacciones</span>
            </div>
          </td>
          <td>
            <span class="font-bold text-green-600">{{ formatearMoneda(servicio.revenue) }}</span>
          </td>
          <td>
            <span class="font-semibold text-red-600">{{ formatearMoneda(servicio.cost) }}</span>
          </td>
          <td>
            <span class="font-bold text-blue-600">{{ formatearMoneda(servicio.profit) }}</span>
          </td>
          <td>
            <p-tag [value]="servicio.profit_margin.toFixed(1) + '%'" [severity]="getProfitSeverity(servicio.profit_margin)"></p-tag>
          </td>
          <td>
            <div class="flex gap-2">
              <button pButton icon="pi pi-eye" class="p-button-text p-button-sm"
                      pTooltip="Ver detalle" (click)="verDetalleServicio(servicio)"></button>
              <button pButton icon="pi pi-chart-bar" class="p-button-text p-button-sm"
                      pTooltip="An√°lisis" (click)="abrirAnalisisRentabilidad()"></button>
              <button pButton icon="pi pi-download" class="p-button-text p-button-sm"
                      pTooltip="Exportar" (click)="exportarExcel()"></button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center py-12">
            <div class="flex flex-col items-center gap-4">
              <i class="pi pi-shopping-cart text-5xl text-gray-400"></i>
              <div>
                <p class="text-gray-500 text-lg">No hay servicios registrados</p>
                <p class="text-sm text-gray-400">Los servicios aparecer√°n cuando se realicen ventas</p>
              </div>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- MODAL DETALLE SERVICIO -->
  <p-dialog [(visible)]="mostrarDetalleServicio" [modal]="true" [style]="{width: '80vw', maxWidth: '900px'}"
            header="Detalle de Servicio" [closable]="true" [draggable]="false">
    <div *ngIf="servicioSeleccionado" class="space-y-6">
      <!-- Info del servicio -->
      <div class="flex items-center gap-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg transition-colors">
        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center">
          <i class="pi pi-shopping-cart text-blue-600 text-2xl"></i>
        </div>
        <div>
          <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">{{ servicioSeleccionado.service_name }}</h3>
          <p class="text-gray-600 dark:text-gray-300">{{ servicioSeleccionado.quantity_sold }} unidades vendidas ‚Ä¢ {{ servicioSeleccionado.total_sales }} transacciones</p>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            Margen de ganancia: {{ servicioSeleccionado.profit_margin.toFixed(1) }}%
          </p>
        </div>
      </div>

      <!-- Resumen detallado del servicio -->
      <div class="grid gap-4 md:grid-cols-4">
        <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border border-green-200 dark:border-green-700 transition-colors">
          <p class="text-sm text-green-600 dark:text-green-300 font-medium">Ingresos</p>
          <p class="text-2xl font-bold text-green-700 dark:text-green-200">{{ formatearMoneda(servicioSeleccionado.revenue) }}</p>
          <p class="text-xs text-green-500 dark:text-green-400">Total facturado</p>
        </div>
        <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg border border-red-200 dark:border-red-700 transition-colors">
          <p class="text-sm text-red-600 dark:text-red-300 font-medium">Costos</p>
          <p class="text-2xl font-bold text-red-700 dark:text-red-200">{{ formatearMoneda(servicioSeleccionado.cost) }}</p>
          <p class="text-xs text-red-500 dark:text-red-400">Gastos asociados</p>
        </div>
        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-200 dark:border-blue-700 transition-colors">
          <p class="text-sm text-blue-600 dark:text-blue-300 font-medium">Ganancia</p>
          <p class="text-2xl font-bold text-blue-700 dark:text-blue-200">{{ formatearMoneda(servicioSeleccionado.profit) }}</p>
          <p class="text-xs text-blue-500 dark:text-blue-400">Beneficio neto</p>
        </div>
        <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg border border-purple-200 dark:border-purple-700 transition-colors">
          <p class="text-sm text-purple-600 dark:text-purple-300 font-medium">Margen</p>
          <p class="text-2xl font-bold text-purple-700 dark:text-purple-200">{{ servicioSeleccionado.profit_margin.toFixed(1) }}%</p>
          <p class="text-xs text-purple-500 dark:text-purple-400">Rentabilidad</p>
        </div>
      </div>

      <!-- An√°lisis de rendimiento -->
      <div>
        <div class="flex justify-between items-center mb-3">
          <h4 class="font-semibold text-gray-900 dark:text-gray-100">An√°lisis de Rendimiento - {{ periodoSeleccionado().titulo }}</h4>
          <div class="flex gap-2">
            <button pButton label="Exportar" icon="pi pi-download"
                    class="p-button-outlined p-button-sm" (click)="exportarServicio(servicioSeleccionado)"></button>
            <button pButton label="Ir a Empleados" icon="pi pi-users"
                    class="p-button-outlined p-button-sm" (click)="irAModuloEmpleados()"></button>
          </div>
        </div>
        
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">Rendimiento del Servicio</p>
          <div class="grid gap-4 md:grid-cols-2">
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400">Promedio por Transacci√≥n</p>
              <p class="font-semibold text-lg">{{ formatearMoneda(servicioSeleccionado.revenue / servicioSeleccionado.total_sales) }}</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400">Costo por Unidad</p>
              <p class="font-semibold text-lg">{{ formatearMoneda(servicioSeleccionado.cost / servicioSeleccionado.quantity_sold) }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </p-dialog>

  <!-- MODAL AN√ÅLISIS DE RENTABILIDAD -->
  <p-dialog [(visible)]="mostrarAnalisisRentabilidad" [modal]="true" [style]="{width: '80vw', maxWidth: '1000px'}"
            header="An√°lisis de Rentabilidad del Negocio" [closable]="true" [draggable]="false">
    <div class="space-y-6">
      <!-- Resumen general -->
      <div class="grid gap-4 md:grid-cols-3">
        <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border border-green-200 dark:border-green-700">
          <p class="text-sm text-green-600 dark:text-green-300 font-medium">Servicio M√°s Rentable</p>
          <p class="text-lg font-bold text-green-700 dark:text-green-200">{{ obtenerServicioMasRentable()?.service_name || 'N/A' }}</p>
          <p class="text-xs text-green-500 dark:text-green-400">{{ obtenerServicioMasRentable()?.profit_margin?.toFixed(1) || '0' }}% margen</p>
        </div>
        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
          <p class="text-sm text-blue-600 dark:text-blue-300 font-medium">Rendimiento Promedio</p>
          <p class="text-lg font-bold text-blue-700 dark:text-blue-200">{{ calcularRendimientoPromedio().toFixed(1) }}%</p>
          <p class="text-xs text-blue-500 dark:text-blue-400">Margen general</p>
        </div>
        <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
          <p class="text-sm text-purple-600 dark:text-purple-300 font-medium">Total Servicios</p>
          <p class="text-lg font-bold text-purple-700 dark:text-purple-200">{{ servicesPerformance().length }}</p>
          <p class="text-xs text-purple-500 dark:text-purple-400">Activos</p>
        </div>
      </div>
      
      <!-- Recomendaciones -->
      <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg border border-yellow-200 dark:border-yellow-700">
        <h4 class="font-semibold text-yellow-800 dark:text-yellow-200 mb-2">üí° Recomendaciones</h4>
        <ul class="text-sm text-yellow-700 dark:text-yellow-300 space-y-1">
          <li>‚Ä¢ Promocionar servicios con mayor margen de ganancia</li>
          <li>‚Ä¢ Revisar costos de servicios con bajo rendimiento</li>
          <li>‚Ä¢ Considerar ajustar precios seg√∫n la demanda</li>
        </ul>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="flex gap-2">
        <button pButton label="Cerrar" icon="pi pi-times" class="p-button-outlined"
                (click)="mostrarAnalisisRentabilidad = false"></button>
        <button pButton label="Exportar An√°lisis" icon="pi pi-download" class="p-button-success"
                (click)="exportarPDF()"></button>
      </div>
    </ng-template>
  </p-dialog>





  <p-toast></p-toast>
</div>
